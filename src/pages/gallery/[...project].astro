---
import { getCollection, getEntry, render } from "astro:content";
import type { ImageMetadata } from "astro";
import BaseLayout from "../../layouts/BaseLayout.astro";
import PhotoGallery from "../../components/PhotoGallery.astro";
import { extractExif } from "../../utils/exif";
import { exifConfig } from "../../config/exif";
import {
    humanizeProjectName,
    getNewestPhotoDate,
    findCoverImage,
} from "../../utils/projects";

export async function getStaticPaths() {
    // Discover all projects from www/ directory
    const wwwImages = import.meta.glob<{ default: ImageMetadata }>(
        "/src/content/www/**/*.{jpg,jpeg,JPG,JPEG}",
        { eager: true },
    );

    // Get unique project slugs (including nested paths)
    const projectSlugs = new Set<string>();
    for (const path of Object.keys(wwwImages)) {
        // Match everything between /www/ and the image filename
        const match = path.match(
            /\/src\/content\/www\/(.+)\/[^/]+\.(jpg|jpeg|JPG|JPEG)$/,
        );
        if (match) {
            const fullPath = match[1];
            projectSlugs.add(fullPath);

            // Also add parent paths (e.g., if we have "Travel/Japan", also add "Travel")
            const parts = fullPath.split("/");
            for (let i = 1; i < parts.length; i++) {
                projectSlugs.add(parts.slice(0, i).join("/"));
            }
        }
    }

    return Array.from(projectSlugs).map((slug) => ({
        params: { project: slug },
    }));
}

// Catch-all routes receive the path as an array or string
const projectParam = Astro.params.project;
const projectSlug = Array.isArray(projectParam)
    ? projectParam.join("/")
    : projectParam;

// Load metadata if it exists
const metadata = await getEntry("photoProjects", projectSlug);

// Get title, description, date (from metadata or auto-generate)
const title = metadata?.data.title || humanizeProjectName(projectSlug);
const description = metadata?.data.description || "";
const exifDisplay = metadata?.data.exifDisplay || "inherit";
const exifFields = metadata?.data.exifFields;

// Render markdown content if metadata exists
let Content = null;
if (metadata) {
    const rendered = await render(metadata);
    Content = rendered.Content;
}

// Discover all images in this project's www/ directory
const imagePattern = `/src/content/www/${projectSlug}/**/*.{jpg,jpeg,JPG,JPEG}`;
const allWwwImages = import.meta.glob<{ default: ImageMetadata }>(
    "/src/content/www/**/*.{jpg,jpeg,JPG,JPEG}",
    { eager: true },
);

// Filter images for this project only (directly in this folder, not subfolders)
const projectImages = Object.entries(allWwwImages)
    .filter(([path]) => {
        const relativePath = path.replace(
            `/src/content/www/${projectSlug}/`,
            "",
        );
        // Only include images directly in this folder (no additional slashes)
        return (
            path.startsWith(`/src/content/www/${projectSlug}/`) &&
            !relativePath.includes("/")
        );
    })
    .map(([path, module]) => ({
        path,
        image: module.default,
        filename: path.split("/").pop() || "",
    }))
    .sort((a, b) => a.filename.localeCompare(b.filename));

// If no images found directly, check for sub-projects
let subProjects: Array<{
    slug: string;
    title: string;
    href: string;
    coverImage?: ImageMetadata;
}> = [];
if (projectImages.length === 0) {
    const allProjectSlugs = Array.from(
        new Set(
            Object.keys(allWwwImages)
                .map((path) => {
                    const match = path.match(
                        /\/src\/content\/www\/(.+)\/[^/]+\.(jpg|jpeg|JPG|JPEG)$/,
                    );
                    return match ? match[1] : null;
                })
                .filter(Boolean) as string[],
        ),
    );

    const uniqueSubProjectSlugs = allProjectSlugs
        .filter(
            (slug) =>
                slug.startsWith(`${projectSlug}/`) && slug !== projectSlug,
        )
        .map((slug) => {
            const parts = slug.replace(`${projectSlug}/`, "").split("/");
            // Only get direct children (one level deep)
            return parts.length === 1 ? slug : null;
        })
        .filter(Boolean)
        .filter((slug, index, self) => self.indexOf(slug) === index); // unique

    // Get cover images for each sub-project
    subProjects = await Promise.all(
        uniqueSubProjectSlugs.map(async (slug) => {
            // Get metadata for this sub-project
            const subMetadata = await getEntry("photoProjects", slug!);

            // Get all images for this sub-project
            const subProjectImages = Object.entries(allWwwImages)
                .filter(([path]) =>
                    path.startsWith(`/src/content/www/${slug}/`),
                )
                .map(([path, module]) => ({
                    path,
                    image: module.default,
                    filename: path.split("/").pop() || "",
                }));

            // Find cover image
            const coverImage = await findCoverImage(
                subProjectImages,
                subMetadata?.data.coverImage,
            );

            // Render the sub-project's markdown content
            let subContent = null;
            if (subMetadata) {
                const rendered = await render(subMetadata);
                subContent = rendered.Content;
            }

            return {
                slug: slug!,
                title: subMetadata?.data.title || humanizeProjectName(slug!.split("/").pop()!),
                description: subMetadata?.data.description || "",
                href: `/gallery/${slug}`,
                coverImage: coverImage?.image,
                Content: subContent,
            };
        }),
    );

    subProjects.sort((a, b) => a.title.localeCompare(b.title));
}

// Get date for the project
const date = metadata?.data.date || (await getNewestPhotoDate(projectImages));
const formattedDate = new Date(date).toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
});

// Extract EXIF data for each image
const photos = await Promise.all(
    projectImages.map(async ({ image, path }) => {
        // Convert virtual path to filesystem path
        const fsPath = path.replace(/^\/src\//, "./src/");
        const exif = await extractExif(fsPath);
        return { image, exif };
    }),
);

// Determine if EXIF should be shown
const showExif =
    exifDisplay === "on" ||
    (exifDisplay === "inherit" && exifConfig.defaultDisplay);
---

<BaseLayout
    title={`${title} - Vantage Point Astro`}
    description={description || `Photography project: ${title}`}
>
    <div class="max-w-6xl mx-auto space-y-12">
        <div class="space-y-4">
            <a
                href="/gallery"
                class="text-sm text-gray-400 hover:text-gray-200 transition-colors"
            >
                ‚Üê Back to Gallery
            </a>
            <div class="space-y-2">
                <h1 class="text-4xl font-light">{title}</h1>
                <p class="text-sm text-gray-400">{formattedDate}</p>
            </div>
            {
                /* Only show content above for multi-image galleries (not sub-projects, not single image) */
                Content && subProjects.length === 0 && photos.length > 1 && (
                    <div class="prose prose-gray max-w-none">
                        <Content />
                    </div>
                )
            }
            {
                !Content && description && subProjects.length === 0 && photos.length > 1 && (
                    <p class="text-gray-300">{description}</p>
                )
            }
        </div>

        {
            subProjects.length > 0 ? (
                <div class="space-y-12">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        {subProjects.map((project) => (
                            <a
                                href={project.href}
                                class="group block space-y-4"
                            >
                                {project.coverImage && (
                                    <div
                                        class="overflow-hidden border"
                                        style="border-color: var(--color-border-main);"
                                    >
                                        <img
                                            src={project.coverImage.src}
                                            alt={project.title}
                                            width={project.coverImage.width}
                                            height={project.coverImage.height}
                                            class="w-full aspect-[4/3] object-cover transition-transform duration-300 group-hover:scale-105"
                                        />
                                    </div>
                                )}
                                <div class="space-y-2">
                                    <h3 class="text-xl font-normal group-hover:opacity-70 transition-opacity">
                                        {project.title}
                                    </h3>
                                    {project.Content && (
                                        <div class="text-sm text-gray-300 prose prose-sm prose-gray max-w-none">
                                            <project.Content />
                                        </div>
                                    )}
                                </div>
                            </a>
                        ))}
                    </div>
                </div>
            ) : photos.length === 1 ? (
                /* Single image - show large with info below */
                <div class="space-y-6">
                    <div class="overflow-hidden">
                        <img
                            src={photos[0].image.src}
                            alt={title}
                            width={photos[0].image.width}
                            height={photos[0].image.height}
                            class="w-full max-w-4xl mx-auto lightbox-image cursor-pointer"
                            data-full-src={photos[0].image.src}
                        />
                    </div>
                    {Content && (
                        <div class="prose prose-gray max-w-2xl mx-auto text-gray-300">
                            <Content />
                        </div>
                    )}
                </div>
            ) : (
                <PhotoGallery photos={photos} showExif={showExif} />
            )
        }
    </div>
</BaseLayout>
